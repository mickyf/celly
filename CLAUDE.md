# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Celly is a wine cellar management application that enables users to track their wine collection, add tasting notes, and get AI-powered food pairing recommendations using Claude API.

## Development Commands

```bash
# Start development server (Vite + Supabase local)
npm run dev

# Build for production (TypeScript + Vite)
npm run build

# Lint codebase
npm run lint

# Preview production build
npm run preview

# Supabase commands
npx supabase start          # Start local Supabase (Docker required)
npx supabase stop           # Stop local Supabase
npx supabase status         # Check Supabase status
npx supabase db reset       # Reset database and apply migrations
npx supabase migration new <name>  # Create new migration
```

## Architecture

### Tech Stack Core
- **Frontend**: React 19 + TypeScript + Vite
- **Routing**: TanStack Router (file-based routing in `src/routes/`)
- **State Management**: TanStack Query for server state
- **UI Framework**: Mantine UI v8 with custom grape theme
- **Backend**: Supabase (PostgreSQL + Auth + Storage)
- **AI Integration**: Anthropic Claude Sonnet 4.5 API

### Data Flow Architecture

**TanStack Query Pattern:**
All server state is managed through custom hooks in `src/hooks/`:
- `useWines()` - Fetch all wines with auto-caching
- `useAddWine()`, `useUpdateWine()`, `useDeleteWine()` - Mutations with automatic cache invalidation
- `useTastingNotes()`, `useDashboardStats()`, `useFoodPairing()` - Similar patterns

**Key Pattern**: Mutations automatically call `queryClient.invalidateQueries()` to refresh data after changes.

### Supabase Integration

**Client Setup** (`src/lib/supabase.ts`):
- Single typed client instance using `Database` type from `src/types/database.ts`
- Environment variables: `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY`

**Database Schema** (see `supabase/migrations/`):
- `wines` table: Core wine data with RLS policies
- `tasting_notes` table: Rating (1-5 stars) + notes + date, cascades on wine deletion
- Row Level Security (RLS): All tables filtered by `auth.uid() = user_id`
- Storage bucket: `wine-images` with user-scoped folders

**Photo Upload Pattern**:
1. Upload to `wine-images/{user_id}/{wineId}.{ext}` via `useUploadWinePhoto()`
2. Get public URL from Supabase Storage
3. Update wine record with `photo_url`

### Routing Structure (TanStack Router)

File-based routes in `src/routes/`:
- `__root.tsx` - App shell with AppShell layout and auth check
- `index.tsx` - Dashboard with statistics
- `login.tsx` - Auth page (login/signup tabs)
- `wines/index.tsx` - Wine list with search/filter
- `wines/add.tsx` - Add wine form
- `wines/$id.tsx` - Wine detail with tasting notes
- `wines/$id.edit.tsx` - Edit wine form
- `pairing.tsx` - AI food pairing interface

**Route Tree**: Auto-generated by `@tanstack/router-plugin` in `vite.config.ts`. Do not manually edit `src/routeTree.gen.ts`.

### Component Architecture

**Reusable Components** (`src/components/`):
- `WineForm.tsx` - Complex form with photo dropzone, grape tags, vintage/price inputs, drinking window ranges
- `WineCard.tsx` - Display wine in grid with "Ready to Drink" badge calculation
- `WineFilters.tsx` - Collapsible search/filter panel with multi-select grapes, vintage/price ranges, drinking window status
- `TastingNoteForm.tsx` - Rating widget + date picker + textarea using `@mantine/form`
- `TastingNoteCard.tsx` - Display note with rating stars and formatted date

**Forms**: Use `@mantine/form` (not react-hook-form). Form validation in `validate` object, no external schema libraries.

### AI Food Pairing Flow

**Implementation** (`src/lib/claude.ts`):
1. Filter wines to those in drinking window: `currentYear >= drink_window_start AND currentYear <= drink_window_end`
2. Format wine list as numbered text for Claude
3. Send prompt to Claude Sonnet 4.5 requesting JSON response with pairing recommendations
4. Parse JSON, map `wineIndex` back to actual wine IDs
5. Display ranked results with explanations and pairing scores

**API Configuration**:
- Uses `dangerouslyAllowBrowser: true` for local development
- Expects `VITE_CLAUDE_API_KEY` environment variable
- Error handling in `useFoodPairing` hook shows notifications

### TypeScript Type Safety

**Database Types** (`src/types/database.ts`):
- Generated Supabase types (manually created, not auto-generated)
- Use `Database['public']['Tables']['wines']['Row']` pattern
- Import types with `type` keyword due to `verbatimModuleSyntax` in tsconfig

**Type Import Pattern**:
```typescript
// Correct
import { type WineFormValues } from './WineForm'

// Incorrect (will cause TS error)
import { WineFormValues } from './WineForm'
```

### Mantine UI Theme

**Custom Theme** (`src/main.tsx`):
- Primary color: `grape` (purple/wine tones)
- Custom color scale defined in `MantineProvider`
- Default radius: `md`
- All Mantine CSS imports required in `main.tsx`

**Required CSS Imports**:
```typescript
import '@mantine/core/styles.css'
import '@mantine/notifications/styles.css'
import '@mantine/dropzone/styles.css'
import '@mantine/dates/styles.css'
import '@mantine/charts/styles.css'
```

## Environment Setup

Required environment variables in `.env.local`:

```bash
# Supabase (get from `npx supabase start` output)
VITE_SUPABASE_URL=http://127.0.0.1:54321
VITE_SUPABASE_ANON_KEY=<anon-key>

# Claude API (get from console.anthropic.com)
VITE_CLAUDE_API_KEY=sk-ant-<your-key>
```

Copy `.env.example` to `.env.local` and fill in values.

## Database Migrations

**Creating Migrations**:
```bash
npx supabase migration new <descriptive_name>
```

**Applying Migrations**:
```bash
npx supabase db reset  # Resets DB and applies all migrations
```

**Schema Changes**:
- Always update `src/types/database.ts` to match schema changes
- RLS policies must be included in migration for new tables
- Storage policies for new buckets must be defined in migrations

## Common Patterns

### Adding a New Data Entity

1. Create migration in `supabase/migrations/`
2. Add table types to `src/types/database.ts`
3. Create custom hooks in `src/hooks/use<Entity>.ts` with query/mutation functions
4. Create form component in `src/components/<Entity>Form.tsx` using `@mantine/form`
5. Create display component in `src/components/<Entity>Card.tsx`
6. Create routes in `src/routes/<entity>/` for list/detail/add/edit

### Search/Filter Implementation

Filter logic uses `useMemo` for performance (see `src/routes/wines/index.tsx`):
- Combine filters with AND logic (all filters must match)
- Text search: case-insensitive `includes()`
- Arrays (grapes): `some()` for OR logic within filter
- Ranges: check both min and max boundaries
- Drinking window: calculate `isReady`, `isFuture`, `isPast` based on current year

### Photo Upload Pattern

```typescript
// 1. Upload file
const photoUrl = await uploadPhoto.mutateAsync({ file, wineId })

// 2. Update record with URL
await updateWine.mutateAsync({ id: wineId, photo_url: photoUrl })
```

Storage path: `{user_id}/{wineId}.{ext}` for automatic RLS via storage policies.

## Known Constraints

- **Single User**: No multi-user/sharing features (intentionally scoped out)
- **Local Development**: Supabase runs locally via Docker (requires Docker Desktop)
- **No Import/Export**: Users cannot bulk import or export wine data
- **No Location Tracking**: Physical cellar location not tracked
- **Browser API Keys**: Claude API key exposed in browser (acceptable for local dev, needs backend proxy for production)

## Deployment Considerations

Currently local-only. For cloud deployment:
1. Create Supabase project at supabase.com
2. Run `npx supabase db push` to push schema
3. Update environment variables to cloud URLs
4. Deploy frontend to Vercel/Netlify
5. Create storage bucket `wine-images` with public read access
6. Move Claude API calls to backend Edge Function to protect API key
